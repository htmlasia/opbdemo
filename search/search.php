<?php

$data = array(
    array(
        'type' => 'page',
        'category' => 'member_pages',
        'title' => 'Pension pay dates and direct deposit',
        'description' => 'This page provides you with the latest PSPP pay schedule',
        'breadcrums' => array('Home', 'Retired members', 'Welcome to retirement'),
        'date' => '2023-02-16 10:18:50',
        'image' => ''
    ),
    array(
        'type' => 'page',
        'category' => 'current_pages',
        'title' => 'Overview',
        'description' => "Whether you're a retired member or a surviving spouse/beneficiary, there's some critical information you need to know about your pension benefits.",
        'breadcrums' => array('Home', 'Retired members', 'Welcome to retirement'),
        'date' => '2023-02-16 10:18:50',
        'image' => '',
    ),
    array(
        'type' => 'page',
        'title' => 'Retirement administration',
        'category' => 'retired_members',
        'description' => 'Overview of the mechanics related to pension payments; i.e., pension formula, payment dates, CPP integration',
        'breadcrums' => array('Home', 'Retired members', 'Welcome to retirement'),
        'date' => '2023-02-16 10:18:50',
        'image' => ''
    ),
    array(
        'type' => 'articles',
        'category' => 'news',
        'title' => 'Cost-of-living increases for Retired Members',
        'description' => '',
        'date' => '2023-02-16 10:18:50',
        'image' => '../assets0215/img/img_search_01.jpg'
    ),
    array(
        'type' => 'articles',
        'category' => 'news',
        'title' => 'Pensions to increase by 1.6 per cent for 2018 cost-of-living adjustment',
        'description' => '',
        'date' => '2023-02-18 10:18:50',
        'image' => '../assets0215/img/img_search_03.jpg'
    ),
    array(
        'type' => 'articles',
        'category' => 'letter',
        'title' => 'Your 2023 cost-of-living adjustment',
        'description' => '',
        'date' => '2023-02-15 10:18:50',
        'image' => '../assets0215/img/img_search_02.jpg'
    ),
    array(
        'type' => 'articles',
        'category' => 'blog',
        'title' => 'Pensions to increase by 1.3 percent for 2017 cost-of-living-adjustment',
        'description' => '',
        'date' => '2023-02-19 10:18:50',
        'image' => '../assets0215/img/img_search_04.jpg'
    ),
    array(
        'type' => 'articles',
        'category' => 'letter',
        'title' => 'Pensions to increase by 2.2% on Jan 1, 2019',
        'description' => '',
        'date' => '2023-02-13 10:18:50',
        'image' => '../assets0215/img/img_search_05.jpg'
    ),
    array(
        'type' => 'forms',
        'category' => 'enrollment',
        'name' => 'opb',
        'code' => 'OPB1004',
        'title' => 'Retired Member Information Change (PDF)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'opb',
        'code' => 'OPB1004',
        'title' => 'Agricorp Retired/Survivor or Deferred Information Change (PDF)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'opb',
        'code' => 'OPB1004',
        'title' => 'ONTC Retired/Survivor or Deferred Information Change (PDF)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'opb',
        'code' => 'OPB1004',
        'title' => 'TVO Retired/Survivor or Deferred Information Change (PDF)',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'opb',
        'code' => 'OPB1006',
        'title' => 'Increased Survivor Pension Application (PDF)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'opb',
        'code' => 'OPB1011',
        'title' => 'Certificate of Health (PDF)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'opb',
        'code' => 'OPB1015',
        'title' => 'Beneficiary Designation (on e-Services)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'opb',
        'code' => 'OPB1031',
        'title' => 'Declaration of Attendance at School, College or University (PDF)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'canada',
        'code' => 'Canada Life #169493 M445D',
        'title' => 'Dental Benefits Claim for Legacy Plan: 50% co-pay (PDF)',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'buyback',
        'name' => 'opb',
        'code' => 'OPB1043',
        'title' => 'Application to Purchase Pension Credit (PDF)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'fsra',
        'code' => 'FSRA FL-1',
        'title' => 'Application for Family Law Value',
        'date' => '2023-04-24 15:30:00',
        'link' => 'https://www.example.com/forms/opb1055.pdf',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'forms',
        'category' => 'retirement',
        'name' => 'cowan',
        'code' => 'Cowan',
        'title' => 'Consent to Medical/Physical Information for Disability Pension (PDF)',
        'date' => '2023-04-24 15:30:00',
        'description' => 'Document description to help user understand what they can use it for. This description may also span to multiple lines. We can set a character limit.'
    ),
    array(
        'type' => 'publications',
        'category' => 'booklet',
        'name' => 'Booklets',
        'title' => 'CPP Integration and your PSPP pension',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:51',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
    ),
    array(
        'type' => 'publications',
        'category' => 'booklet',
        'name' => 'Booklets',
        'title' => 'Understanding Your Pension Credit',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:52',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
    array(
        'type' => 'publications',
        'category' => 'annual_en',
        'name' => 'Flyers and Brochures',
        'title' => 'Expert Commission on Pensions Submission',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:53',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ), array(
        'type' => 'publications',
        'category' => 'flyer',
        'name' => 'Flyers and Brochures',
        'title' => 'Survivor pensions for a new spouse - for retired members',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:54',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ), array(
        'type' => 'publications',
        'category' => 'flyer',
        'name' => 'Flyers and Brochures',
        'title' => 'Dividing pensions, the old rules',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:55',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
);

function getAll($page, $limit, $searchData)
{
    global $data;
    $dataFilter = $data;
    if (!empty($searchData)) {
        $dataFilter = array_filter($data, function ($var) use ($searchData) {
            return (strpos(strtolower($var['title']), strtolower($searchData)) !== false);
        });
    }
    $responseData = array_slice($dataFilter, ($page - 1) * $limit, $limit);
    return $responseData;
}

function getFormAll($page, $limit, $searchData, $type)
{
    global $data;
    $dataFilter = $data;
    $dataFilter = array_filter($data, function ($var) use ($type) {
        return (strpos(strtolower($var['type']), strtolower($type)) !== false);
    });
    if (!empty($searchData)) {
        $dataFilter = array_filter($data, function ($var) use ($searchData) {
            return (strpos(strtolower($var['title']), strtolower($searchData)) !== false);
        });
    }
    $responseData = array_slice($dataFilter, ($page - 1) * $limit, $limit);
    return $responseData;
}
function comparator($object1, $object2)
{
    return $object1->date > $object2->date;
}

function getByType($page, $limit, $searchData, $type, $category, $sort, $name)
{
    global $data;
    $dataFilter = $data;
    $dataFilter = array_filter($data, function ($var) use ($type) {
        return (strpos(strtolower($var['type']), strtolower($type)) !== false);
    });
    if ($type == 'articles' && !$sort || $type == 'publications' && !$sort) {
        $sort = 'desc';
    }
    if ($sort == 'desc') {
        if ($type == 'articles' || $type == 'publications') {
            usort($dataFilter, function ($a, $b) {
                return strtotime($b['date']) - strtotime($a['date']);
            });
        } else {
            usort($dataFilter, function ($a, $b) {
                return $b['title'] > $a['title'];
            });
        }
    } else if ($sort && $sort == 'asc') {
        if ($type == 'articles' || $type == 'publications') {
            usort($dataFilter, function ($a, $b) {
                return strtotime($a['date']) - strtotime($b['date']);
            });
        } else {
            usort($dataFilter, function ($a, $b) {
                return $a['title'] > $b['title'];
            });
        }
    }

    if ($type == 'forms' && $sort && !empty($sort)) {
        if ($sort != 'desc' && $sort != 'asc') {
            $arr = explode("-", $sort);
            $sortType = $arr[0];
            $sortVal = $arr[1];
            $sortFunctions = [
                'Title' => [
                    'desc' => function ($a, $b) {
                        return $b['title'] > $a['title'];
                    },
                    'asc' => function ($a, $b) {
                        return $a['title'] > $b['title'];
                    },
                ],
                'Category' => [
                    'desc' => function ($a, $b) {
                        return $b['category'] > $a['category'];
                    },
                    'asc' => function ($a, $b) {
                        return $a['category'] > $b['category'];
                    },
                ],
                'Code' => [
                    'desc' => function ($a, $b) {
                        return $b['code'] > $a['code'];
                    },
                    'asc' => function ($a, $b) {
                        return $a['code'] > $b['code'];
                    },
                ],
            ];

            if (isset($sortFunctions[$sortType][$sortVal])) {
                usort($dataFilter, $sortFunctions[$sortType][$sortVal]);
            }
        }
    }

    if ($category && !empty($category)) {
        $dataFilter = array_filter($dataFilter, function ($var) use ($category) {
            return (strpos(strtolower($var['category']), strtolower($category)) !== false);
        });
    }
    if ($searchData && !empty($searchData)) {
        $dataFilter = array_filter($dataFilter, function ($var) use ($searchData) {
            return (strpos(strtolower($var['title']), strtolower($searchData)) !== false);
        });
    }
    if ($name && !empty($name)) {
        $dataFilter = array_filter($dataFilter, function ($var) use ($name) {
            return (strpos(strtolower($var['name']), strtolower($name)) !== false);
        });
    }

    $totalResults = count($dataFilter);
    $startIndex = ($page - 1) * $limit;
    $endIndex = $startIndex + $limit;
    $responseData = array_slice($dataFilter, $startIndex, $limit);
    $displayedResults = count($responseData);

    $responseData = array(
        'displayedResults' => $displayedResults,
        'totalResults' => $totalResults,
        'results' => $responseData,
    );

    return $responseData;
}

function getTotal()
{
    global $data;
    $result = array();
    foreach ($data as $element) {
        if (!isset($result[$element['type']])) {
            $result[$element['type']] = 0;
        }
        $result[$element['type']]++;
    }
    $result['all'] = count($data);
    return $result;
}
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') {
        header('Content-Type: application/json');
        if (isset($_POST['action'])) {
            $action = $_POST['action'];
            switch ($action) {
                case 'getAll':
                    $page = $_POST['page'];
                    $limit = $_POST['limit'];
                    $searchData = isset($_POST['searchData']) ? $_POST['searchData'] : '';
                    $result = getAll($page, $limit, $searchData);
                    echo json_encode(array('data' => $result));
                    break;
                case 'getFormAll':
                    $page = $_POST['page'];
                    $limit = $_POST['limit'];
                    $searchData = isset($_POST['searchData']) ? $_POST['searchData'] : '';
                    $result = getFormAll($page, $limit, $searchData, $type = 'forms');
                    echo json_encode(array('data' => $result));
                    break;
                case 'getTotal':
                    $result = getTotal();
                    echo json_encode(array('data' => $result));
                    break;
                case 'getByType':
                    $page = $_POST['page'];
                    $limit = $_POST['limit'];
                    $searchData = isset($_POST['searchData']) ? $_POST['searchData'] : '';
                    $category = $_POST['category'];
                    $type = $_POST['type'];
                    $sort = isset($_POST['sort']) ? $_POST['sort'] : '';
                    $name = $_POST['name'];
                    $result = getByType($page, $limit, $searchData, $type, $category, $sort, $name);
                    echo json_encode(array('data' => $result));
                    break;
                default:
                    header("HTTP/1.0 404 Not Found");
                    exit;
            }
        } else {
            header("HTTP/1.0 400 Bad Request");
            exit;
        }
        exit;
    }
}
